#!/bin/bash
export PYTHONIOENCODING=utf8
RED='\033[0;31m'
GREEN='\033[0;32m'
NC='\033[0m' # No Color
LOCK_STATE=$HOME/.agent/.lock-state
if [ -f $LOCK_STATE ];
then
   	echo "The device ${DEVICE_ID} has already installed successfully."
else	
	echo "Activating the device with ID:${DEVICE_ID}"
	DEVICE_OBJECT=$(curl -H "Content-Type: application/json" -L https://apps.citus.io/apisrv/device-lifecycle-service/device/${DEVICE_ID}?secret_key=${SECRET_KEY})
	
	DEVICE_STATUS=$(echo ${DEVICE_OBJECT} | python -c "import sys, json; print json.load(sys.stdin)['status']" 2> /dev/null)
	SERIAL_NUMBER=$(echo ${DEVICE_OBJECT} | python -c "import sys, json; print json.load(sys.stdin)['_metadata']['serialNumber']" 2> /dev/null)	
	
	if [ "${DEVICE_STATUS}" == "unregistered" ]; then
		PAYLOAD=$(curl -H "Content-Type: application/json" -X POST -d '{"name":"'"${DEVICE_ID}"'","serialNumber":"'"${SERIAL_NUMBER}"'","status":"'"${DEVICE_STATUS}"'"}' -L https://apps.citus.io/apisrv/device-lifecycle-service/lifecycle/initialization?secret_key=${SECRET_KEY})	
		PINCODE=$(echo ${PAYLOAD} | python -c "import sys, json; print json.load(sys.stdin)['pincode']")
		echo -e "${RED}========================="
		echo -e "| ACTIVATION CODE: ${PINCODE} |"
		echo -e "=========================${NC}"
		if [ "${SELF_ACTIVATION}" == "YES" ]; then
			PAYLOAD=$(curl -H "Content-Type: application/json" -X POST -d '{"name":"'"${DEVICE_ID}"'","serialNumber":"'"${SERIAL_NUMBER}"'","status":"'"${DEVICE_STATUS}"'","pincode":"'"${PINCODE}"'"}' -L https://apps.citus.io/apisrv/device-lifecycle-service/lifecycle/registration?secret_key=${SECRET_KEY})
			mkdir -p $HOME/.agent/certs/
			RESULT=$(echo ${PAYLOAD} | python -c "import sys, json; print json.load(sys.stdin)['certificates']['certificatePem']" 2> /dev/null)	
			echo "${RESULT}" >> "$HOME/.agent/certs/${DEVICE_ID}-certificate.pem.crt"
			RESULT=$(echo ${PAYLOAD} | python -c "import sys, json; print json.load(sys.stdin)['certificates']['keyPair']['PrivateKey']" 2> /dev/null)	
			echo "${RESULT}" >> "$HOME/.agent/certs/${DEVICE_ID}-private-pem.key"
			curl -o "$HOME/.agent/certs/root-CA.crt" https://www.symantec.com/content/en/us/enterprise/verisign/roots/VeriSign-Class%203-Public-Primary-Certification-Authority-G5.pem
			RESULT=$(echo ${PAYLOAD} | python -c "import sys, json; print json.load(sys.stdin)['device']['status']" 2> /dev/null)
			echo "${RESULT}" >> ${LOCK_STATE}
			echo -e "${GREEN}==============================="
			echo -e "| ACTIVATION DONE: ${RESULT} |"
			echo -e "===============================${NC}"
			echo "Try 'citus-device install-sdk' to start writing your code."
		fi
	elif [ "${DEVICE_STATUS}" == "registered" ]; then
		echo -e "${RED}The DeviceID: ${DEVICE_ID} has already used on another device! Please pickup another one and try again.${NC}"
	else
		echo -e "${RED}Invalid DEVICE_ID or SECRET_KEY parameter!${NC}"
	fi
fi